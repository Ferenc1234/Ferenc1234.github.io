<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta charset="UTF-8" />
  <title>Dynamic Form</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.google.com/recaptcha/api.js?render=6LeNLFQrAAAAAE1PT3plAyvknxmEemxdQv0KrPFS"></script>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.google.com/recaptcha/ https://www.gstatic.com;
    frame-src https://www.google.com/recaptcha/;
    connect-src 'self' https://hidden-term-c0fc.frubacek.workers.dev;
    style-src 'self' 'unsafe-inline';
  ">
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <style>
    body {
      background: linear-gradient(135deg, #1e1e2f, #121218);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #eee;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    textarea {
      resize: vertical !important;
    }
  </style>
</head>

<body>
  <div id="form-container"></div>

  <script>
    async function loadForm() {
      const res = await fetch('https://hidden-term-c0fc.frubacek.workers.dev/');
      const fields = await res.json();

      const container = document.getElementById('form-container');
      const form = document.createElement('form');
      form.id = 'dynamic-form';
      form.style.display = 'flex';
      form.style.flexDirection = 'column';
      form.style.gap = '1rem';

      const errorsDiv = document.createElement('div');
      errorsDiv.style.color = 'red';

      const successDiv = document.createElement('div');
      successDiv.style.color = 'lightgreen';

      const MAX_FILE_SIZE = 10 * 1024 * 1024;

      fields.forEach(field => {
        const wrapper = document.createElement('div');

        const label = document.createElement('label');
        label.innerHTML = field.label + (field.required ? ' <span style="color:red">*</span>' : '') + ':';

        let input;
        if (field.type === 'textarea') {
          input = document.createElement('textarea');
          input.style.resize = 'vertical';
        } else {
          input = document.createElement('input');
          input.type = field.type;
        }

        input.name = field.name;
        if (field.required) input.required = true;

        input.style.width = '100%';
        input.style.boxSizing = 'border-box';

        const errorMsg = document.createElement('div');
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '0.9em';
        errorMsg.className = 'error-message';

        const validateField = () => {
          const val = input.value;
          let error = '';

          if (field.required) {
            if (!val || (field.type === 'file' && input.files.length === 0)) {
              error = `Pole ${field.label} je povinné.`;
            } else if (field.type === 'email') {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(val)) {
                error = 'Zadejte prosím platnou e-mailovou adresu.';
              }
            }
          }

          if (field.type === 'file') {
            const file = input.files[0];
            if (file && file.size > MAX_FILE_SIZE) {
              error = `Soubor "${file.name}" je příliš velký. Maximální velikost je 10MB.`;
            }
          }

          errorMsg.textContent = error;
          return error === '';
        };

        input.addEventListener(field.type === 'file' ? 'change' : 'input', validateField);

        label.appendChild(document.createElement('br'));
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        wrapper.appendChild(errorMsg);
        form.appendChild(wrapper);
      });

      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.textContent = 'Send';
      submitBtn.style.width = '100%';
      submitBtn.style.position = 'relative';
      submitBtn.style.padding = '0.8rem';
      submitBtn.style.fontSize = '1rem';
      submitBtn.style.borderRadius = '0.5rem';
      submitBtn.style.background = 'linear-gradient(135deg, #7f5af0, #5c3bba)';
      submitBtn.style.color = 'white';
      submitBtn.style.border = 'none';
      submitBtn.style.cursor = 'pointer';
      submitBtn.style.transition = 'background 0.3s ease';

      submitBtn.addEventListener('mouseover', () => {
        submitBtn.style.background = 'linear-gradient(135deg, #9a77ff, #7152d0)';
      });
      submitBtn.addEventListener('mouseout', () => {
        submitBtn.style.background = 'linear-gradient(135deg, #7f5af0, #5c3bba)';
      });

      form.appendChild(submitBtn);
      container.appendChild(form);
      container.appendChild(errorsDiv);
      container.appendChild(successDiv);

      form.addEventListener('submit', async e => {
        e.preventDefault();
        errorsDiv.textContent = '';
        successDiv.textContent = '';

        let isValid = true;
        fields.forEach(field => {
          const input = form.elements[field.name];
          const errorMsg = input.closest('div').querySelector('.error-message');
          const fieldValid = errorMsg.textContent === '';
          if (!fieldValid) isValid = false;
        });

        if (!isValid) {
          errorsDiv.textContent = 'Prosím opravte chyby výše před odesláním.';
          return;
        }

        const formData = new FormData(form);

        try {
          const token = await grecaptcha.execute('6LeNLFQrAAAAAE1PT3plAyvknxmEemxdQv0KrPFS', { action: 'submit' });
          formData.append('captcha', token);

          const res = await fetch('https://hidden-term-c0fc.frubacek.workers.dev/', {
            method: 'POST',
            body: formData,
          });

          const result = await res.json();

          if (result.success) {
            successDiv.textContent = result.message;
            form.reset();
            form.querySelectorAll('.error-message').forEach(el => el.textContent = '');
          } else {
            errorsDiv.textContent = result.message || 'Neznámá chyba.';
            console.error('Chyba při odesílání e-mailu:', result.error);
          }
        } catch (err) {
          errorsDiv.textContent = 'Chyba sítě nebo serveru: ' + err.message;
        }
      });
    }

    loadForm();
  </script>
</body>
</html>